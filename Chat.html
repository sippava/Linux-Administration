<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Valtterin Chat ðŸ’¬</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .chat-container {
      width: 100%;
      max-width: 600px;
      background: #fff;
      border: 2px solid #0066cc;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background: #0066cc;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .messages {
      flex: 1;
      height: 400px;
      overflow-y: auto;
      padding: 15px;
      background: #f9f9f9;
    }
    .message {
      margin-bottom: 10px;
    }
    .message.own { text-align: right; }
    .message-bubble {
      display: inline-block;
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 12px;
      background: #e0e0e0;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
    }
    .message.own .message-bubble {
      background: #0066cc;
      color: white;
    }
    .message-meta {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }
    .message.own .message-meta {
      color: #ddd;
    }
    .system-message {
      text-align: center;
      font-size: 0.85rem;
      color: #888;
      margin: 8px 0;
    }
    .input-area {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    .nickname-input, .message-input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
      flex: 1;
    }
    .nickname-input { max-width: 150px; }
    .send-btn {
      padding: 8px 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .send-btn:hover {
      background: #004999;
    }
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ðŸ’¬ Valtterin Chat</div>
    <div class="messages" id="messages">
      <div class="system-message">ðŸ”Œ YhdistetÃ¤Ã¤n palvelimeen...</div>
    </div>
    <div class="input-area">
      <input type="text" id="nickname" class="nickname-input" placeholder="Nimimerkki" maxlength="20">
      <input type="text" id="messageInput" class="message-input" placeholder="Kirjoita viesti..." disabled>
      <button id="sendBtn" class="send-btn" disabled>ðŸš€ LÃ¤hetÃ¤</button>
    </div>
  </div>

  <script>
    const TOPIC = 'chat/messages';
    const wsUrl = `ws://${window.location.hostname}:9001/mqtt`;
    const client = mqtt.connect(wsUrl, {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      clean: true,
      reconnectPeriod: 3000
    });

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const nicknameInput = document.getElementById('nickname');
    const sendBtn = document.getElementById('sendBtn');
    const shownMessages = new Set();

    nicknameInput.value = localStorage.getItem('mqtt_nickname') || '';
    nicknameInput.addEventListener('change', () => {
      localStorage.setItem('mqtt_nickname', nicknameInput.value);
    });

    client.on('connect', () => {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      addSystemMessage('âœ… Yhdistetty chat-palvelimeen!');
      client.subscribe(TOPIC);
      loadMessagesFromAPI();
    });

    client.on('disconnect', () => {
      messageInput.disabled = true;
      sendBtn.disabled = true;
      addSystemMessage('âš ï¸ Yhteys katkesi...');
    });

    client.on('message', (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        addMessage(data.nickname, data.text, data.clientId === client.options.clientId, data.timestamp);
      } catch (e) {
        addMessage('Tuntematon', message.toString(), false, Date.now());
      }
    });

    function addMessage(nickname, text, isOwn, key) {
      const uniqueKey = nickname + "_" + text + "_" + key;
      if (shownMessages.has(uniqueKey)) return;
      shownMessages.add(uniqueKey);

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message' + (isOwn ? ' own' : '');
      const time = new Date().toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit' });
      messageDiv.innerHTML = `
        <div class="message-bubble">${escapeHtml(text)}</div>
        <div class="message-meta">${escapeHtml(nickname)} â€¢ ${time}</div>
      `;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'system-message';
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      const nickname = nicknameInput.value.trim() || 'Anonyymi';
      if (text && client.connected) {
        const payload = JSON.stringify({
          nickname: nickname,
          text: text,
          clientId: client.options.clientId,
          timestamp: Date.now()
        });
        client.publish(TOPIC, payload);

        fetch("/api/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname: nickname, message: text, client_id: client.options.clientId })
        }).catch(err => console.error("API tallennusvirhe:", err));

        messageInput.value = '';
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    function loadMessagesFromAPI() {
      fetch("/api/messages?limit=50")
        .then(res => res.json())
        .then(data => {
          messagesDiv.innerHTML = "";
          data.forEach(msg => {
            addMessage(msg.nickname, msg.message, false, msg.id || msg.created_at);
          });
        })
        .catch(err => console.error("API hakuvirhe:", err));
    }
  </script>
</body>
</html>
